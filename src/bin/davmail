#!/bin/sh
#
# Usage: davmail [</path/to/davmail.properties>] [-notray] [-tray] [-token]
#
BASE=$(dirname "$0")
# set memory and enable DNS expiration
: "${BASE_JAVA_OPTS:=-Xmx512M -Dsun.net.inetaddr.ttl=60}"
JAVA=java

# Experimental: download Azul JRE FX with command 'davmail azul'
if [ "$1" = 'azul' ]; then
  if [ "$BASE" = '/usr/bin' ]; then
    echo Use platform independent package to run DavMail with Azul JDK
    exit 1
  fi
  if curl -L --fail -o "$BASE/jre.tgz" "https://api.azul.com/zulu/download/community/v1.0/bundles/latest/binary/?jdk_version=21&ext=tar.gz&os=linux&arch=x86&hw_bitness=64&bundle_type=jre&features=fx"; then
    echo Downloaded Azul JRE
  else
    echo Unable to download Azul JRE
    exit 1
  fi;
  rm -Rf "$BASE/jre"
  mkdir "$BASE/jre"
  tar xvzf "$BASE/jre.tgz" -C "$BASE/jre" --strip 1
  rm "$BASE/jre.tgz"
  echo "Downloaded latest Azul JRE, launch davmail normally"
  exit
fi

# use davmail swt to fetch up to date swt library
if [ "$1" = 'swt' ]; then
  if [ "$BASE" = '/usr/bin' ]; then
    echo Use platform independent package to fetch and run up to date swt
    exit 1
  fi
   curl -L -o swt-4.37-win32-win32-x86_64.zip "https://www.eclipse.org/downloads/download.php?file=/eclipse/downloads/drops4/R-4.37-202509050730/swt-4.37-gtk-linux-$(uname -m).zip&mirror_id=1"

  if curl -L --fail -o "$BASE/swt.zip" "https://www.eclipse.org/downloads/download.php?file=/eclipse/downloads/drops4/R-4.37-202509050730/swt-4.37-gtk-linux-$(uname -m).zip&mirror_id=1"; then
    echo Downloaded SWT
  else
    echo Unable to download SWT
    exit 1
  fi;
  unzip swt.zip swt.jar -d "$BASE/lib"
  rm swt.zip
  echo "Downloaded SWT jar, launch davmail normally"
  exit
fi

# check for embedded jre
if [ -e "$BASE/jre/bin/java" ]; then
  JAVA=$BASE/jre/bin/java
  : "${JFX_JAVA_OPTS:=--add-exports java.base/sun.net.www.protocol.https=ALL-UNNAMED}"
  echo "Using embedded JRE"
  $JAVA -version
elif  java -version 2>&1 >/dev/null | grep -q "version" ; then
  echo "Using system provided JRE"
  java -version

  if [ -e "/usr/lib/jvm/openjfx" ]; then
    echo "Enable OpenJFX"
    : "${JFX_JAVA_OPTS:=--add-exports java.base/sun.net.www.protocol.https=ALL-UNNAMED -Djava.library.path=/usr/lib/jvm/openjfx --module-path /usr/lib/jvm/openjfx --add-modules javafx.base,javafx.controls,javafx.web,javafx.fxml,javafx.swing}"
  elif [ -e "/usr/share/openjfx" ]; then
    # matches Kubuntu
    echo "Enable OpenJFX"
    : "${JFX_JAVA_OPTS:=--add-exports java.base/sun.net.www.protocol.https=ALL-UNNAMED}"
  else
    # add JFX to classpath with OpenJDK 11
    JFX_CLASSPATH=/usr/share/java/javafx-base.jar:/usr/share/java/javafx-controls.jar:/usr/share/java/javafx-fxml.jar:/usr/share/java/javafx-graphics.jar:/usr/share/java/javafx-media.jar:/usr/share/java/javafx-swing.jar:/usr/share/java/javafx-web.jar
  fi
elif [ -e "$BASE/davmail.jar" ]; then
  # display message for platform independent package
  echo "Java not found, try davmail azul to fetch latest Azul JRE"
  exit 1
fi

if [ -e "$BASE/lib/swt.jar" ]; then
    echo use embedded SWT
elif [ -e /usr/lib/java/swt.jar ]; then
    # latest SWT on Fedora
    : "${SWT_JAVA_OPTS:=--enable-native-access=ALL-UNNAMED}"
    SWT_CLASSPATH=/usr/lib/java/swt.jar
elif [ -e /usr/share/java/swt4.jar ]; then
    # SWT 4 is available (debian, ubuntu)
    export LD_LIBRARY_PATH=/usr/lib/jni
    SWT_CLASSPATH=/usr/share/java/swt4.jar
else
    SWT_CLASSPATH=
fi

: "${JAVA_OPTS:=$BASE_JAVA_OPTS $JFX_JAVA_OPTS $SWT_JAVA_OPTS}"

# shellcheck disable=SC2086
if [ -e "$BASE/davmail.jar" ]; then
    # this is the platform independent package
    exec "${JAVA}" $JAVA_OPTS -cp "$BASE/davmail.jar:$BASE/lib/*:${SWT_CLASSPATH}:${JFX_CLASSPATH}" davmail.DavGateway "$@"
else
    exec "${JAVA}" $JAVA_OPTS -cp "/usr/share/davmail/davmail.jar:${SWT_CLASSPATH}:${JFX_CLASSPATH}:/usr/share/davmail/lib/*" davmail.DavGateway "$@"
fi
